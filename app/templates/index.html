<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Collection Manager</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Game Collection">
    <meta name="theme-color" content="#ffffff">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='icons/apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='icons/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='icons/favicon-16x16.png') }}">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        .sortable {
            cursor: pointer;
            position: relative;
            padding-right: 25px !important;  
        }
        
        .sortable::after {
            content: '↕';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.3;
            font-size: 0.9em;  
        }
        
        .sortable.sort-asc::after {
            content: '↑';
            opacity: 1;
        }
        
        .sortable.sort-desc::after {
            content: '↓';
            opacity: 1;
        }
        
        @media (max-width: 767.98px) {
            .sortable {
                padding-right: 20px !important;  
            }
            
            .sortable::after {
                right: 4px;  
                font-size: 0.8em;  
            }
            
            .table th {
                font-size: 0.9em;  
            }
        }
        
        .pagination {
            justify-content: center;
            margin-top: 1rem;
        }
        
        .table th {
            white-space: nowrap;
        }
        
        .table {
            table-layout: fixed;
            width: 100%;
        }
        
        /* Mobile-first column widths */
        .name-col {
            width: 75%;
        }
        .console-col {
            width: 25%;
        }
        
        /* Desktop column widths */
        @media (min-width: 768px) {
            .status-col {
                width: 50px;
            }
            .name-col {
                width: 35%;
            }
            .console-col {
                width: 20%;
            }
            .price-col {
                width: 15%;
            }
            .change-col {
                width: 15%;
            }
            .date-col {
                width: 15%;
            }
        }
        
        /* Hide columns on mobile */
        @media (max-width: 767.98px) {
            .d-none.d-md-table-cell,
            .date-col,
            .console-col {
                display: none !important;
            }
            
            /* Ensure name column takes full width on mobile */
            .name-col {
                width: 100% !important;
            }
        }
        
        /* Ensure content truncates properly */
        .table td, .table th {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            vertical-align: middle;
        }
        
        /* Expanded content should stretch full width */
        .expanded-content td {
            white-space: normal;
        }
        
        .game-details {
            display: none;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin: 0.5rem;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .game-details.show {
            display: block;
        }
        
        .game-details dl {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            margin: 0;
        }
        
        .game-details dl > div {
            flex: 1 1 140px;
            min-width: 140px;
            max-width: 200px;
        }
        
        .game-details dl > div.full-width {
            flex: 1 0 100%;
            max-width: 100%;
        }
        
        .game-details dl > div.full-width dd {
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.4;
            max-width: 100%;
        }
        
        .game-details dt {
            font-weight: 600;
            color: #666;
            margin-bottom: 0.25rem;
        }
        
        .game-details dd {
            margin: 0;
        }
        
        @media (max-width: 767.98px) {
            .game-details {
                margin: 0.5rem 0;
            }
            
            .game-details dl {
                gap: 1rem;
            }
            
            .game-details dl > div {
                min-width: 120px;
            }
            
            .details-row td {
                padding: 0 !important;
            }
            
            .details-row .game-details {
                width: 100%;
                border-left: 0;
                border-right: 0;
                border-radius: 0;
            }
        }
        
        .full-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.3;
        }
        
        @media (max-width: 767.98px) {
            .full-name {
                font-size: 1.1rem;
                margin-bottom: 0.75rem;
                padding-bottom: 0.375rem;
            }
        }
        
        .game-row {
            cursor: pointer;
        }
        
        .game-row.selected {
            background-color: #f8f9fa;
        }
        
        #gameDetailsContainer {
            margin-top: 1rem;
        }
        
        .advanced-search-btn:focus {
            box-shadow: none;
        }
        
        #advancedSearch {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.25rem;
            margin-top: 1rem;
        }
        
        /* Main styles */
        body {
            padding-top: 1.5rem;
            padding-bottom: 1.5rem;
        }
        
        /* Lighter placeholder text for better distinction from actual values */
        ::placeholder {
            color: #adb5bd !important;
            opacity: 0.6 !important;
        }
        
        /* For Microsoft browsers */
        ::-ms-input-placeholder {
            color: #adb5bd !important;
            opacity: 0.6 !important;
        }
        
        .sparkline-container {
            width: 100%;
            height: 60px;
            margin-top: 15px;
            margin-bottom: 5px;
        }
        
        /* Add additional margin for y-axis labels */
        .sparkline-chart {
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="card mb-4">
            <div class="card-header">
                <div class="row g-3">
                    <div class="col-md-8">
                        <div class="input-group">
                            <button class="btn btn-outline-primary" type="button" id="addToWishlistBtn" title="Add to Wishlist">
                                <span>+</span>
                            </button>
                            <input type="text" id="searchInput" class="form-control" placeholder="Search games...">
                        </div>
                        <div id="resultCount" class="text-muted mt-1"></div>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-secondary w-100" type="button" id="advancedSearchBtn">
                            Advanced Search
                        </button>
                    </div>
                </div>
                <div class="mt-3" id="advancedSearch" style="display: none;">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Console</label>
                            <select id="consoleFilter" class="form-select">
                                <option value="">All Consoles</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Status</label>
                            <select id="statusFilter" class="form-select">
                                <option value="">All Status</option>
                                <option value="owned">Owned</option>
                                <option value="wanted">Wanted</option>
                                <option value="lent">Lent Out</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Condition</label>
                            <select id="conditionFilter" class="form-select">
                                <option value="">All Conditions</option>
                                <option value="loose">Loose</option>
                                <option value="cib">CIB</option>
                                <option value="new">New</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <div class="table-responsive">
                        <table id="collectionTable" class="table table-hover">
                            <thead>
                                <tr>
                                    <th class="status-col sortable d-none d-md-table-cell" data-sort="is_wanted" aria-label="Sort by wanted/owned status"></th>
                                    <th class="name-col sortable" data-sort="name">Name</th>
                                    <th class="console-col sortable" data-sort="console">Console</th>
                                    <th class="price-col sortable d-none d-md-table-cell" data-sort="current_price">Price</th>
                                    <th class="change-col sortable d-none d-md-table-cell" data-sort="value_change">Value Change</th>
                                    <th class="date-col sortable d-none d-md-table-cell" data-sort="acquisition_date">Added</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Server-side pagination -->
                <nav id="collectionPagination" aria-label="Collection pagination">
                </nav>
            </div>
        </div>
    </div>

    <div class="container text-center pb-4">
        <a href="/logout" class="btn btn-outline-danger">Logout</a>
    </div>

    <!-- Wishlist/Add Game Dialog -->
    <div class="modal fade" id="wishlistModal" tabindex="-1" aria-labelledby="wishlistModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="wishlistModalLabel">Add Game</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Tab navigation -->
                    <ul class="nav nav-tabs mb-3" id="addGameTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="wishlist-tab" data-bs-toggle="tab" 
                                    data-bs-target="#wishlist-tab-pane" type="button" role="tab" 
                                    aria-controls="wishlist-tab-pane" aria-selected="true">
                                Add to Wishlist
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="purchased-tab" data-bs-toggle="tab" 
                                    data-bs-target="#purchased-tab-pane" type="button" role="tab" 
                                    aria-controls="purchased-tab-pane" aria-selected="false">
                                Add as Purchased
                            </button>
                        </li>
                    </ul>
                    
                    <form id="gameForm">
                        <!-- Common fields for both options -->
                        <div class="mb-3">
                            <label for="pricechartingUrl" class="form-label">Pricecharting.com URL</label>
                            <input type="url" class="form-control" id="pricechartingUrl" 
                                   placeholder="Enter the URL of the game from pricecharting.com (e.g., https://www.pricecharting.com/game/nintendo-switch/mario-tennis-aces)" required>
                            <div class="form-text">Enter the URL of the game from pricecharting.com</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="gameCondition" class="form-label">Condition</label>
                            <select class="form-select" id="gameCondition">
                                <option value="complete" selected>Complete</option>
                                <option value="loose">Loose</option>
                                <option value="new">New</option>
                            </select>
                        </div>
                        
                        <!-- Tab content with conditional fields -->
                        <div class="tab-content" id="addGameTabContent">
                            <!-- Wishlist tab pane (empty, just uses common fields) -->
                            <div class="tab-pane fade show active" id="wishlist-tab-pane" role="tabpanel" 
                                 aria-labelledby="wishlist-tab" tabindex="0">
                                <!-- No additional fields needed for wishlist -->
                            </div>
                            
                            <!-- Purchased tab pane with purchase-specific fields -->
                            <div class="tab-pane fade" id="purchased-tab-pane" role="tabpanel" 
                                 aria-labelledby="purchased-tab" tabindex="0">
                                <div class="mt-3 p-3 border rounded bg-light">
                                    <h6 class="mb-3">Purchase Details</h6>
                                    
                                    <div class="mb-3">
                                        <label for="purchaseDate" class="form-label">Purchase Date</label>
                                        <input type="date" class="form-control" id="purchaseDate" 
                                               value="2025-03-25">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="purchaseSource" class="form-label">Source</label>
                                        <input type="text" class="form-control" id="purchaseSource" 
                                               placeholder="Where did you purchase this game? (e.g., eBay, GameStop)">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="purchasePrice" class="form-label">Price</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" class="form-control" id="purchasePrice" 
                                                   placeholder="Enter purchase price (e.g., 29.99)" step="0.01" min="0">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="formError" class="alert alert-danger d-none mt-3"></div>
                        <div id="formSuccess" class="alert alert-success d-none mt-3"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitGameBtn">Add to Wishlist</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Initializing collection manager...');
            
            // Initialize arrays
            let allGames = [];
            let filteredGames = [];
            const ITEMS_PER_PAGE = 30;

            // Show loading state
            function showLoading() {
                const tbody = document.querySelector('#collectionTable tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">Loading games...</td></tr>';
                }
            }

            // Load all games from API
            async function loadAllGames() {
                try {
                    showLoading();
                    console.log('Loading all games from API...');
                    const response = await fetch('/api/collection');
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }
                    allGames = await response.json();
                    filteredGames = [...allGames];
                    console.log('Loaded games from API:', allGames.length);
                    renderGames(allGames, true, 1);
                } catch (error) {
                    console.error('Error loading games:', error);
                    const tbody = document.querySelector('#collectionTable tbody');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading games. Please refresh the page to try again.</td></tr>';
                    }
                }
            }
            
            // Generate pagination HTML
            function generatePaginationHTML(currentPage, totalPages) {
                if (totalPages <= 1) return ''; // Don't show pagination if only one page
                
                let pages = new Set(); // Use Set to avoid duplicates
                
                // Always add first and last pages
                pages.add(1);
                pages.add(totalPages);
                
                // Add current page and one page on either side
                for (let i = currentPage - 1; i <= currentPage + 1; i++) {
                    if (i > 1 && i < totalPages) {  // Don't add first/last pages again
                        pages.add(i);
                    }
                }
                
                // Convert to sorted array
                let pageArray = Array.from(pages).sort((a, b) => a - b);
                
                // Add ellipses where needed
                let finalPages = [];
                for (let i = 0; i < pageArray.length; i++) {
                    if (i > 0 && pageArray[i] > pageArray[i-1] + 1) {
                        finalPages.push('...');
                    }
                    finalPages.push(pageArray[i]);
                }
                
                return `
                    <ul class="pagination justify-content-center">
                        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                            <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>
                        </li>
                        ${finalPages.map(page => {
                            if (page === '...') {
                                return '<li class="page-item disabled"><span class="page-link">...</span></li>';
                            }
                            return `
                                <li class="page-item ${page === currentPage ? 'active' : ''}">
                                    <a class="page-link" href="#" data-page="${page}">${page}</a>
                                </li>
                            `;
                        }).join('')}
                        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                            <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
                        </li>
                    </ul>
                `;
            }
            
            // Format currency
            window.formatCurrency = function(value) {
                if (value === null || value === undefined || isNaN(value)) return '-';
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
            }
            
            // Format value change percentage
            function formatValueChange(current, purchase) {
                if (!current || !purchase) return '-';
                
                const change = (current - purchase) / purchase * 100;
                const formattedChange = change.toFixed(1);
                const sign = change >= 0 ? '+' : '';
                const color = change >= 0 ? 'success' : 'danger';
                
                return `<span class="text-${color}">${sign}${formattedChange}%</span>`;
            }
            
            // Filter games
            function filterGames(games, searchTerm) {
                const consoleFilter = document.getElementById('consoleFilter').value.toLowerCase();
                const statusFilter = document.getElementById('statusFilter').value;
                const conditionFilter = document.getElementById('conditionFilter').value.toLowerCase();
                
                return games.filter(game => {
                    const matchesSearch = !searchTerm || 
                        game.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        game.console.toLowerCase().includes(searchTerm.toLowerCase());
                    
                    const matchesConsole = !consoleFilter || 
                        game.console.toLowerCase() === consoleFilter;
                    
                    const matchesStatus = !statusFilter || 
                        (statusFilter === 'owned' && !game.is_wanted && !game.is_lent) ||
                        (statusFilter === 'wanted' && game.is_wanted) ||
                        (statusFilter === 'lent' && game.is_lent);
                    
                    const matchesCondition = !conditionFilter || 
                        (game.condition && game.condition.toLowerCase() === conditionFilter);
                    
                    return matchesSearch && matchesConsole && matchesStatus && matchesCondition;
                });
            }
            
            // Get current page of games
            function getCurrentPageGames(games, page) {
                const startIndex = (page - 1) * ITEMS_PER_PAGE;
                return games.slice(startIndex, startIndex + ITEMS_PER_PAGE);
            }
            
            // Render games with pagination
            function renderGames(games, preserveFilteredGames = false, page = 1) {
                console.log('Rendering games:', games.length);
                const tbody = document.querySelector('#collectionTable tbody');
                if (!tbody) {
                    console.error('Collection table body not found!');
                    return;
                }

                // Store filtered games if this is a new filter operation
                if (!preserveFilteredGames) {
                    console.log('Updating filtered games array');
                    filteredGames = [...games];
                }

                // Calculate pagination
                const itemsPerPage = 30;
                const totalPages = Math.ceil(games.length / itemsPerPage);
                const startIndex = (page - 1) * itemsPerPage;
                const endIndex = Math.min(startIndex + itemsPerPage, games.length);
                const pageGames = games.slice(startIndex, endIndex);
                
                // Update result count
                const resultCount = document.getElementById('resultCount');
                if (resultCount) {
                    resultCount.textContent = `Showing ${startIndex + 1}-${endIndex} of ${games.length} results`;
                }

                if (!games || games.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No games found</td></tr>';
                    return;
                }
                
                // Clear any existing event listeners
                const oldRows = document.querySelectorAll('.game-row');
                oldRows.forEach(row => {
                    row.replaceWith(row.cloneNode(true));
                });
                
                // Render table rows with details rows
                tbody.innerHTML = pageGames.map(game => {
                    const valueChange = !game.is_wanted ? formatValueChange(game.current_price, game.purchase_price) : '-';
                    let statusIcon, status;
                    if (game.is_wanted) {
                        statusIcon = '🔖';
                        status = 'Wanted';
                    } else if (game.is_lent) {
                        statusIcon = '📤';
                        status = 'Lent Out';
                    } else {
                        statusIcon = '✓';
                        status = 'Purchased';
                    }
                    
                    return `
                        <tr class="game-row" data-game-id="${game.id}">
                            <td class="status-col d-none d-md-table-cell">${statusIcon}</td>
                            <td class="name-col" title="${game.name}">${game.name}</td>
                            <td class="console-col" title="${game.console}">${game.console}</td>
                            <td class="d-none d-md-table-cell" title="${formatCurrency(game.current_price)}">${formatCurrency(game.current_price)}</td>
                            <td class="d-none d-md-table-cell">${valueChange}</td>
                            <td class="d-none d-md-table-cell" title="${game.acquisition_date || '-'}">${game.acquisition_date || '-'}</td>
                        </tr>
                        <tr class="details-row">
                            <td colspan="6" class="p-0">
                                <div class="game-details" data-game-id="${game.id}">
                                    <div class="full-name">${game.name}</div>
                                    <dl>
                                        <div>
                                            <dt>Console</dt>
                                            <dd>${game.console}</dd>
                                        </div>
                                        <div>
                                            <dt>Status</dt>
                                            <dd>${status}</dd>
                                        </div>
                                        ${game.is_wanted ? `
                                        <div>
                                            <dt>Current Price</dt>
                                            <dd>${formatCurrency(game.current_price)}</dd>
                                        </div>
                                        <div>
                                            <dt>Last Price Update</dt>
                                            <dd>
                                                <span id="last-update-${game.id}">Loading...</span>
                                                <button class="btn btn-sm btn-outline-primary ms-2 update-price-btn" 
                                                        data-game-id="${game.id}" 
                                                        style="font-size: 0.75rem; padding: 0.2rem 0.5rem;">
                                                    Update Price
                                                </button>
                                            </dd>
                                        </div>
                                        ` : game.is_lent ? `
                                        <div>
                                            <dt>Lent Date</dt>
                                            <dd>${game.lent_date || '-'}</dd>
                                        </div>
                                        <div>
                                            <dt>Lent To</dt>
                                            <dd>${game.lent_to || '-'}</dd>
                                        </div>
                                        <div>
                                            <dt>Bought</dt>
                                            <dd>${formatCurrency(game.purchase_price)}</dd>
                                        </div>
                                        <div>
                                            <dt>Current</dt>
                                            <dd>${formatCurrency(game.current_price)}</dd>
                                        </div>
                                        <div>
                                            <dt>Change</dt>
                                            <dd>${valueChange}</dd>
                                        </div>
                                        <div>
                                            <dt>Acquired</dt>
                                            <dd>${game.acquisition_date || '-'}</dd>
                                        </div>
                                        <div>
                                            <dt>Last Price Update</dt>
                                            <dd>
                                                <span id="last-update-${game.id}">Loading...</span>
                                                <button class="btn btn-sm btn-outline-primary ms-2 update-price-btn" 
                                                        data-game-id="${game.id}" 
                                                        style="font-size: 0.75rem; padding: 0.2rem 0.5rem;">
                                                    Update Price
                                                </button>
                                            </dd>
                                        </div>
                                        ` : `
                                        <div>
                                            <dt>Bought</dt>
                                            <dd>${formatCurrency(game.purchase_price)}</dd>
                                        </div>
                                        <div>
                                            <dt>Current</dt>
                                            <dd>${formatCurrency(game.current_price)}</dd>
                                        </div>
                                        <div>
                                            <dt>Change</dt>
                                            <dd>${valueChange}</dd>
                                        </div>
                                        <div>
                                            <dt>Acquired</dt>
                                            <dd>${game.acquisition_date || '-'}</dd>
                                        </div>
                                        <div>
                                            <dt>Last Price Update</dt>
                                            <dd>
                                                <span id="last-update-${game.id}">Loading...</span>
                                                <button class="btn btn-sm btn-outline-primary ms-2 update-price-btn" 
                                                        data-game-id="${game.id}" 
                                                        style="font-size: 0.75rem; padding: 0.2rem 0.5rem;">
                                                    Update Price
                                                </button>
                                            </dd>
                                        </div>
                                        `}
                                    </dl>
                                    <div class="full-width">
                                        <dt>Price History</dt>
                                        <dd>
                                            <div id="sparkline-${game.id}" class="sparkline-container"></div>
                                        </dd>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                // Add click handlers
                document.querySelectorAll('.game-row').forEach(row => {
                    row.addEventListener('click', function(e) {
                        const gameId = this.dataset.gameId;
                        const detailsDiv = document.querySelector(`.game-details[data-game-id="${gameId}"]`);
                        
                        if (!detailsDiv) return;
                        
                        const wasVisible = detailsDiv.classList.contains('show');
                        
                        // Hide all details and remove selected state
                        document.querySelectorAll('.game-details').forEach(div => div.classList.remove('show'));
                        document.querySelectorAll('.game-row').forEach(r => r.classList.remove('selected'));
                        
                        // Show this one if it wasn't visible
                        if (!wasVisible) {
                            detailsDiv.classList.add('show');
                            this.classList.add('selected');
                            
                            // Fetch and show price history
                            fetchPriceHistory(gameId);
                        }
                    });
                });
                
                // Update pagination UI
                const pagination = document.getElementById('collectionPagination');
                if (pagination) {
                    pagination.innerHTML = generatePaginationHTML(page, totalPages);
                    
                    // Add click handlers for pagination
                    pagination.querySelectorAll('.page-link').forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const newPage = parseInt(e.target.dataset.page);
                            if (!isNaN(newPage)) {
                                renderGames(games, true, newPage);
                            }
                        });
                    });
                }
            }
            
            // Sort games by a specific key
            function sortGames(games, sortKey, sortOrder) {
                console.log(`Sorting games by ${sortKey} in ${sortOrder} order`);
                return [...games].sort((a, b) => {
                    let aVal, bVal;
                    
                    if (sortKey === 'is_wanted') {
                        aVal = a[sortKey] ? 1 : 0;
                        bVal = b[sortKey] ? 1 : 0;
                    } else if (sortKey === 'current_price') {
                        aVal = parseFloat(a[sortKey]) || 0;
                        bVal = parseFloat(b[sortKey]) || 0;
                    } else if (sortKey === 'value_change') {
                        // Calculate value change percentage for sorting
                        const aChange = !a.is_wanted && a.current_price && a.purchase_price ? 
                            ((a.current_price - a.purchase_price) / a.purchase_price) * 100 : -Infinity;
                        const bChange = !b.is_wanted && b.current_price && b.purchase_price ? 
                            ((b.current_price - b.purchase_price) / b.purchase_price) * 100 : -Infinity;
                        
                        aVal = aChange;
                        bVal = bChange;
                    } else if (sortKey === 'acquisition_date') {
                        aVal = a[sortKey] ? new Date(a[sortKey]).getTime() : 0;
                        bVal = b[sortKey] ? new Date(b[sortKey]).getTime() : 0;
                    } else {
                        aVal = a[sortKey];
                        bVal = b[sortKey];
                    }
                    
                    // Handle null values for non-value_change fields
                    if (sortKey !== 'value_change') {
                        if (aVal === null || aVal === undefined) aVal = sortOrder === 'asc' ? '\uffff' : '';
                        if (bVal === null || bVal === undefined) bVal = sortOrder === 'asc' ? '\uffff' : '';
                    }
                    
                    // Compare the values
                    if (aVal < bVal) return sortOrder === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sortOrder === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            // Setup sorting functionality
            function setupSorting(tableId, defaultSort = 'name', defaultOrder = 'asc') {
                console.log('Setting up sorting');
                const table = document.getElementById(tableId);
                if (!table) {
                    console.error('Table not found:', tableId);
                    return;
                }
                
                let currentSort = defaultSort;
                let currentOrder = defaultOrder;
                
                const headers = table.querySelectorAll('th.sortable');
                headers.forEach(header => {
                    const sortKey = header.dataset.sort;
                    console.log('Setting up sort header:', sortKey);
                    
                    if (sortKey === defaultSort) {
                        header.classList.add(`sort-${defaultOrder}`);
                    }
                    
                    header.addEventListener('click', () => {
                        console.log('Sort header clicked:', sortKey);
                        // Update sort direction
                        if (sortKey === currentSort) {
                            currentOrder = currentOrder === 'asc' ? 'desc' : 'asc';
                        } else {
                            currentSort = sortKey;
                            currentOrder = 'asc';
                        }
                        
                        console.log('New sort:', currentSort, currentOrder);
                        
                        // Update header classes
                        headers.forEach(h => {
                            h.classList.remove('sort-asc', 'sort-desc');
                        });
                        header.classList.add(`sort-${currentOrder}`);
                        
                        // Sort the games
                        console.log('Sorting games, count:', filteredGames.length);
                        const sortedGames = sortGames(filteredGames, currentSort, currentOrder);
                        renderGames(sortedGames, true, 1); // Reset to first page when sorting
                    });
                });
                
                return { currentSort, currentOrder };
            }

            // Setup table search functionality
            function setupTableSearch() {
                console.log('Setting up table search');
                const searchInput = document.getElementById('searchInput');
                if (!searchInput) {
                    console.error('Search input not found!');
                    return;
                }
                
                let debounceTimeout;
                searchInput.addEventListener('input', (e) => {
                    console.log('Search input changed:', e.target.value);
                    clearTimeout(debounceTimeout);
                    debounceTimeout = setTimeout(() => {
                        const searchTerm = e.target.value;
                        console.log('Filtering with term:', searchTerm);
                        const filtered = filterGames(allGames, searchTerm);
                        console.log('Found filtered games:', filtered.length);
                        renderGames(filtered, false, 1); // Reset to first page when filtering
                    }, 300);
                });
            }

            // Add function to populate console filter
            function populateConsoleFilter(games) {
                const consoles = [...new Set(games.map(game => game.console))].sort();
                const consoleFilter = document.getElementById('consoleFilter');
                
                consoles.forEach(consoleName => {
                    const option = document.createElement('option');
                    option.value = consoleName.toLowerCase();
                    option.textContent = consoleName;
                    consoleFilter.appendChild(option);
                });
            }

            // Initialize
            console.log('Starting initialization...');
            await loadAllGames(); // Load all games first
            setupTableSearch();
            
            // Populate console filter after loading games
            populateConsoleFilter(allGames);
            
            // Setup advanced search toggle
            const advancedSearchBtn = document.getElementById('advancedSearchBtn');
            const advancedSearchPanel = document.getElementById('advancedSearch');
            
            advancedSearchBtn.addEventListener('click', () => {
                const isHidden = advancedSearchPanel.style.display === 'none';
                advancedSearchPanel.style.display = isHidden ? 'block' : 'none';
                advancedSearchBtn.setAttribute('aria-expanded', !isHidden);
            });
            
            // Add event listeners for advanced filters
            const applyFilters = () => {
                const searchTerm = document.getElementById('searchInput').value;
                const filtered = filterGames(allGames, searchTerm);
                const resultCount = document.getElementById('resultCount');
                if (resultCount) {
                    resultCount.textContent = `${filtered.length} games found`;
                }
                renderGames(filtered, false, 1);
            };
            
            document.getElementById('consoleFilter').addEventListener('change', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('conditionFilter').addEventListener('change', applyFilters);
            
            const { currentSort, currentOrder } = setupSorting('collectionTable', 'acquisition_date', 'desc');
            // Apply initial sort
            const initialSortedGames = sortGames(filteredGames, currentSort, currentOrder);
            renderGames(initialSortedGames, true, 1);
            
            // Setup wishlist functionality
            setupWishlistDialog();
            
            console.log('Initialization complete');
        });
        
        // Wishlist functionality
        function setupWishlistDialog() {
            const addToWishlistBtn = document.getElementById('addToWishlistBtn');
            const wishlistModal = new bootstrap.Modal(document.getElementById('wishlistModal'));
            const submitGameBtn = document.getElementById('submitGameBtn');
            const gameForm = document.getElementById('gameForm');
            const urlInput = document.getElementById('pricechartingUrl');
            const conditionSelect = document.getElementById('gameCondition');
            const errorDiv = document.getElementById('formError');
            const successDiv = document.getElementById('formSuccess');
            
            const wishlistTab = document.getElementById('wishlist-tab');
            const purchasedTab = document.getElementById('purchased-tab');
            const wishlistTabPane = document.getElementById('wishlist-tab-pane');
            const purchasedTabPane = document.getElementById('purchased-tab-pane');
            
            let currentMode = 'wishlist'; // Default mode
            
            // Toggle purchased fields based on tab selection
            wishlistTab.addEventListener('click', () => {
                currentMode = 'wishlist';
                submitGameBtn.textContent = 'Add to Wishlist';
            });
            
            purchasedTab.addEventListener('click', () => {
                currentMode = 'purchased';
                submitGameBtn.textContent = 'Add Purchased Game';
            });
            
            // Show the modal when the add button is clicked
            addToWishlistBtn.addEventListener('click', () => {
                resetGameForm();
                wishlistModal.show();
            });
            
            // Handle form submission
            submitGameBtn.addEventListener('click', async () => {
                // Validate form
                if (!urlInput.value) {
                    showError('Please enter a valid pricecharting.com URL');
                    return;
                }
                
                // Validate URL format
                if (!urlInput.value.startsWith('https://www.pricecharting.com/game/')) {
                    showError('URL must be from pricecharting.com and follow the format https://www.pricecharting.com/game/{console}/{game-name}');
                    return;
                }
                
                // Determine if adding to wishlist or as purchased
                const isWishlist = currentMode === 'wishlist';
                
                // Additional validation for purchased games
                if (!isWishlist) {
                    const purchaseDate = document.getElementById('purchaseDate').value;
                    const purchasePrice = document.getElementById('purchasePrice').value;
                    
                    if (!purchaseDate) {
                        showError('Please enter a purchase date');
                        return;
                    }
                    
                    if (!purchasePrice) {
                        showError('Please enter a purchase price');
                        return;
                    }
                }
                
                // Disable button to prevent multiple submissions
                submitGameBtn.disabled = true;
                submitGameBtn.textContent = isWishlist ? 'Adding to Wishlist...' : 'Adding Purchased Game...';
                
                try {
                    // Prepare data to send
                    let requestData = {
                        url: urlInput.value,
                        condition: conditionSelect.value
                    };
                    
                    // Add purchase details if needed
                    if (!isWishlist) {
                        requestData.purchase_date = document.getElementById('purchaseDate').value;
                        requestData.purchase_source = document.getElementById('purchaseSource').value || null;
                        requestData.purchase_price = document.getElementById('purchasePrice').value;
                    }
                    
                    // Make API request to the appropriate endpoint
                    const endpoint = isWishlist ? '/api/wishlist/add' : '/api/collection/add';
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || `Failed to add game ${isWishlist ? 'to wishlist' : 'to collection'}`);
                    }
                    
                    console.log(`Successfully added game ${isWishlist ? 'to wishlist' : 'to collection'}:`, data);
                    
                    // Show success message
                    const successMessage = isWishlist 
                        ? `Added ${data.game.name} (${data.game.console}) to your wishlist!`
                        : `Added ${data.game.name} (${data.game.console}) to your collection!`;
                    showSuccess(successMessage);
                    
                    // Reset form after 2 seconds and reload page to show new item
                    setTimeout(() => {
                        wishlistModal.hide();
                        window.location.reload();
                    }, 2000);
                    
                } catch (error) {
                    console.error(`Error adding game ${isWishlist ? 'to wishlist' : 'to collection'}:`, error);
                    // Show error message
                    showError(error.message || 'An error occurred');
                    
                } finally {
                    // Re-enable button
                    submitGameBtn.disabled = false;
                    submitGameBtn.textContent = isWishlist ? 'Add to Wishlist' : 'Add Purchased Game';
                }
            });
            
            // Helper functions
            function resetGameForm() {
                gameForm.reset();
                errorDiv.classList.add('d-none');
                successDiv.classList.add('d-none');
                submitGameBtn.disabled = false;
                
                // Set current date for the purchase date
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('purchaseDate').value = today;
                
                // Reset to default tab (wishlist)
                currentMode = 'wishlist';
                submitGameBtn.textContent = 'Add to Wishlist';
                
                // Activate the wishlist tab
                const tabTrigger = new bootstrap.Tab(wishlistTab);
                tabTrigger.show();
            }
            
            function showError(message) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
            }
            
            function showSuccess(message) {
                successDiv.textContent = message;
                successDiv.classList.remove('d-none');
                errorDiv.classList.add('d-none');
            }
        }
        
        // Function to fetch price history and render sparkline
        async function fetchPriceHistory(gameId) {
            try {
                const sparklineContainer = document.getElementById(`sparkline-${gameId}`);
                if (!sparklineContainer) return;
                
                // Show loading state
                sparklineContainer.innerHTML = '<div class="text-center"><small>Loading price history...</small></div>';
                
                // Fetch price history data from API
                const response = await fetch(`/api/game/${gameId}/price_history`);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    sparklineContainer.innerHTML = `<div class="text-center text-muted"><small>${errorData.error || 'Failed to load price history'}</small></div>`;
                    return;
                }
                
                const priceHistory = await response.json();
                
                if (!priceHistory || priceHistory.length === 0) {
                    sparklineContainer.innerHTML = '<div class="text-center text-muted"><small>No price history available</small></div>';
                    return;
                }
                
                // Create a chart container with proper height
                sparklineContainer.innerHTML = '<div class="sparkline-chart"></div>';
                const chartElement = sparklineContainer.querySelector('.sparkline-chart');
                
                // Debug
                console.log('Price history data:', priceHistory);
                
                // Ensure data is sorted by date (ascending)
                priceHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // Prepare data for sparkline
                const seriesData = priceHistory.map(item => {
                    // Ensure we have valid numbers
                    const price = item.price !== null && item.price !== undefined ? parseFloat(item.price) : null;
                    return isNaN(price) ? null : price;
                }).filter(price => price !== null);
                
                // Debug
                console.log('Series data:', seriesData);
                
                if (seriesData.length === 0) {
                    sparklineContainer.innerHTML = '<div class="text-center text-muted"><small>No valid price data available</small></div>';
                    return;
                }
                
                const categories = priceHistory.map(item => new Date(item.date).toLocaleDateString());
                
                // Get first and last values for y-axis labels
                const firstValue = seriesData[0];
                const lastValue = seriesData[seriesData.length - 1];
                
                // Create sparkline chart
                const options = {
                    series: [{
                        name: 'Value',
                        data: seriesData
                    }],
                    chart: {
                        type: 'area',
                        height: 60,
                        sparkline: {
                            enabled: true
                        },
                        animations: {
                            enabled: true,
                            easing: 'easeinout',
                            speed: 800
                        },
                        toolbar: {
                            show: false
                        }
                    },
                    stroke: {
                        curve: 'smooth',
                        width: 2
                    },
                    fill: {
                        opacity: 0.3
                    },
                    tooltip: {
                        enabled: true,
                        fixed: {
                            enabled: false
                        },
                        x: {
                            show: true,
                            formatter: function(value, { series, seriesIndex, dataPointIndex }) {
                                return categories[dataPointIndex];
                            }
                        },
                        y: {
                            formatter: function (value) {
                                return window.formatCurrency(value);
                            },
                            title: {
                                formatter: () => 'Value:'
                            }
                        }
                    },
                    colors: ['#4CAF50'],
                    grid: {
                        show: false,
                        padding: {
                            left: 0,
                            right: 0
                        }
                    },
                    xaxis: {
                        labels: {
                            show: false
                        },
                        axisTicks: {
                            show: false
                        },
                        axisBorder: {
                            show: false
                        }
                    },
                    yaxis: {
                        labels: {
                            show: false
                        },
                        min: Math.floor(Math.min(...seriesData) * 0.95),
                        max: Math.ceil(Math.max(...seriesData) * 1.05)
                    }
                };
                
                // Only add annotations if we have valid data
                if (firstValue !== undefined && lastValue !== undefined) {
                    // Remove annotations - we don't want to show the labels
                }
                
                try {
                    const chart = new ApexCharts(chartElement, options);
                    chart.render();
                } catch (chartError) {
                    console.error('Error rendering chart:', chartError);
                    sparklineContainer.innerHTML = '<div class="text-center text-muted"><small>Error rendering price chart</small></div>';
                }
            } catch (error) {
                console.error('Error fetching price history:', error);
                const sparklineContainer = document.getElementById(`sparkline-${gameId}`);
                if (sparklineContainer) {
                    sparklineContainer.innerHTML = `<div class="text-center text-muted"><small>Error: ${error.message}</small></div>`;
                }
            }
        }

        // Price update functionality
        async function updateGamePrice(gameId) {
            const button = document.querySelector(`.update-price-btn[data-game-id="${gameId}"]`);
            if (!button) return;
            
            const originalText = button.textContent;
            button.textContent = 'Retrieving...';
            button.disabled = true;
            
            try {
                const response = await fetch(`/api/game/${gameId}/update_price`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    button.textContent = 'Updated!';
                    button.classList.remove('btn-outline-primary');
                    button.classList.add('btn-success');
                    
                    // Refresh the last update date
                    await fetchLastPriceUpdate(gameId);
                    
                    // Reset button after 2 seconds
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.disabled = false;
                        button.classList.remove('btn-success');
                        button.classList.add('btn-outline-primary');
                    }, 2000);
                    
                    // Reload games to show updated prices
                    setTimeout(() => {
                        loadAllGames();
                    }, 1000);
                    
                } else {
                    button.textContent = 'Failed';
                    button.classList.remove('btn-outline-primary');
                    button.classList.add('btn-danger');
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.disabled = false;
                        button.classList.remove('btn-danger');
                        button.classList.add('btn-outline-primary');
                    }, 2000);
                }
                
            } catch (error) {
                console.error('Error updating price:', error);
                button.textContent = 'Error';
                button.classList.remove('btn-outline-primary');
                button.classList.add('btn-danger');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                    button.classList.remove('btn-danger');
                    button.classList.add('btn-outline-primary');
                }, 2000);
            }
        }
        
        async function fetchLastPriceUpdate(gameId) {
            try {
                const response = await fetch(`/api/game/${gameId}/last_price_update`);
                const result = await response.json();
                
                const updateElement = document.getElementById(`last-update-${gameId}`);
                if (updateElement) {
                    if (result.last_update) {
                        const date = new Date(result.last_update);
                        updateElement.textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                    } else {
                        updateElement.textContent = 'Never';
                    }
                }
            } catch (error) {
                console.error('Error fetching last price update:', error);
                const updateElement = document.getElementById(`last-update-${gameId}`);
                if (updateElement) {
                    updateElement.textContent = 'Error';
                }
            }
        }
        
        // Set up event delegation for price update buttons
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('update-price-btn')) {
                e.preventDefault();
                e.stopPropagation();
                const gameId = e.target.dataset.gameId;
                if (gameId) {
                    updateGamePrice(gameId);
                }
            }
        });
        
        // Fetch last update dates when game details are shown
        const originalFetchPriceHistory = fetchPriceHistory;
        fetchPriceHistory = function(gameId) {
            originalFetchPriceHistory(gameId);
            fetchLastPriceUpdate(gameId);
        };

    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register("{{ url_for('static', filename='js/service-worker.js') }}")
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>
</html>
